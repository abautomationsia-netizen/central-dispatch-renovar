<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Renovar CD - S√∫per Simple</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            text-align: center;
        }
        h1 { 
            color: #333; 
            margin-bottom: 10px; 
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .step { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 10px; 
            border-left: 4px solid #007bff;
            text-align: left;
        }
        .step-num { 
            background: #007bff; 
            color: white; 
            border-radius: 50%; 
            width: 25px; 
            height: 25px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 10px; 
            font-weight: bold; 
            font-size: 14px;
        }
        .btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 18px; 
            margin: 15px 5px; 
            width: calc(100% - 10px);
            transition: all 0.3s;
        }
        .btn:hover { 
            background: #0056b3; 
            transform: translateY(-2px);
        }
        .btn:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.success { 
            background: #28a745; 
        }
        .status { 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 8px; 
            display: none; 
            font-weight: 500;
        }
        .status.success { 
            background: #d4edda; 
            color: #155724; 
            border: 2px solid #c3e6cb;
        }
        .status.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 2px solid #f5c6cb;
        }
        .status.loading { 
            background: #fff3cd; 
            color: #856404; 
            border: 2px solid #ffeaa7;
        }
        iframe { 
            width: 100%; 
            height: 400px; 
            border: 3px solid #007bff; 
            border-radius: 8px; 
            margin: 20px 0;
        }
        .hidden { 
            display: none; 
        }
        .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .security {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">üîê</div>
        <h1>Renovaci√≥n Central Dispatch</h1>
        <div class="subtitle">Proceso s√∫per simple y autom√°tico</div>
        
        <!-- PASO 1: Instrucciones -->
        <div id="instructions">
            <div class="step">
                <span class="step-num">1</span>
                <strong>Hacer login</strong> en Central Dispatch cuando se abra
            </div>
            <div class="step">
                <span class="step-num">2</span>
                <strong>Esperar</strong> a que aparezca el dashboard
            </div>
            <div class="step">
                <span class="step-num">3</span>
                <strong>Hacer click</strong> en "Capturar" para terminar
            </div>
            
            <button class="btn" onclick="abrirCD()">
                üöÄ Comenzar Renovaci√≥n
            </button>
            
            <div class="security">
                üõ°Ô∏è <strong>100% Seguro:</strong> Tus credenciales van directo a tu sistema n8n. 
                No se guardan en ning√∫n lado.
            </div>
        </div>
        
        <!-- PASO 2: Login -->
        <div id="loginArea" class="hidden">
            <iframe id="cdFrame" src="about:blank"></iframe>
            
            <button class="btn" onclick="capturar()" id="captureBtn">
                üîë Capturar y Actualizar
            </button>
            
            <button class="btn" onclick="volver()" style="background: #6c757d;">
                ‚Üê Volver a Instrucciones
            </button>
        </div>
        
        <!-- ESTADO -->
        <div class="status" id="status"></div>
    </div>

    <script>
        // ‚ö†Ô∏è IMPORTANTE: CAMBIAR ESTA URL POR LA REAL DE TU N8N
        let n8nUrl = 'TU_N8N_INSTANCE.hostinger.com'; // CAMBIAR AQU√ç
        
        function abrirCD() {
            // Mostrar √°rea de login
            document.getElementById('instructions').classList.add('hidden');
            document.getElementById('loginArea').classList.remove('hidden');
            
            // Cargar Central Dispatch
            document.getElementById('cdFrame').src = 'https://app.centraldispatch.com/login';
            
            mostrarEstado('loading', 'üåê Abriendo Central Dispatch...');
            
            // Detectar cuando el iframe carga
            document.getElementById('cdFrame').onload = function() {
                mostrarEstado('loading', '‚úÖ Listo. Haz login y presiona "Capturar"');
            };
        }
        
        function volver() {
            document.getElementById('loginArea').classList.add('hidden');
            document.getElementById('instructions').classList.remove('hidden');
            ocultarEstado();
        }
        
        async function capturar() {
            mostrarEstado('loading', 'üîç Capturando credenciales...');
            document.getElementById('captureBtn').disabled = true;
            
            try {
                // Obtener cookies del iframe
                const iframe = document.getElementById('cdFrame');
                let cookies = '';
                
                try {
                    // M√©todo directo
                    cookies = iframe.contentDocument.cookie;
                    console.log('Cookies obtenidas directamente:', cookies.length, 'caracteres');
                } catch (e) {
                    // M√©todo alternativo
                    console.log('Usando m√©todo alternativo...');
                    cookies = await obtenerCookiesAlternativo();
                }
                
                if (!cookies || cookies.length < 10) {
                    throw new Error('No se encontraron credenciales v√°lidas. Aseg√∫rate de haber hecho login completamente.');
                }
                
                mostrarEstado('loading', 'üì§ Enviando credenciales de forma segura...');
                
                // Enviar al webhook de n8n
                const response = await fetch(`https://${n8nUrl}/webhook/cd-renovado`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cookies: cookies,
                        timestamp: Date.now(),
                        source: 'pagina_simple'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}. Verifica que n8n est√© funcionando.`);
                }
                
                // √âxito
                mostrarEstado('success', '‚úÖ ¬°Credenciales renovadas exitosamente!\\n\\nYa puedes continuar buscando cargas.\\n\\nEsta ventana se cerrar√° autom√°ticamente.');
                
                document.getElementById('captureBtn').textContent = '‚úÖ Completado';
                document.getElementById('captureBtn').classList.add('success');
                
                // Auto-cerrar despu√©s de 4 segundos
                setTimeout(() => {
                    window.close();
                }, 4000);
                
            } catch (error) {
                console.error('Error completo:', error);
                mostrarEstado('error', `‚ùå Error: ${error.message}`);
                document.getElementById('captureBtn').disabled = false;
                
                // Mostrar ayuda adicional
                setTimeout(() => {
                    const ayuda = document.createElement('div');
                    ayuda.innerHTML = `
                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 13px;">
                            <strong>üí° Soluciones:</strong><br>
                            ‚Ä¢ Verifica que est√©s completamente logueado<br>
                            ‚Ä¢ Aseg√∫rate de estar en el dashboard principal<br>
                            ‚Ä¢ Prueba refrescar la p√°gina de login<br>
                            ‚Ä¢ Si persiste, intenta de nuevo en unos minutos
                        </div>
                    `;
                    document.getElementById('status').appendChild(ayuda);
                }, 1000);
            }
        }
        
        function obtenerCookiesAlternativo() {
            return new Promise((resolve, reject) => {
                const iframe = document.getElementById('cdFrame');
                
                const messageHandler = (event) => {
                    if (event.data && event.data.type === 'COOKIES_RESULT') {
                        window.removeEventListener('message', messageHandler);
                        if (event.data.success) {
                            resolve(event.data.cookies);
                        } else {
                            reject(new Error(event.data.error || 'Error obteniendo cookies'));
                        }
                    }
                };
                
                window.addEventListener('message', messageHandler);
                
                // Script para inyectar en iframe
                const script = `
                    try {
                        const cookies = document.cookie;
                        window.parent.postMessage({
                            type: 'COOKIES_RESULT',
                            success: true,
                            cookies: cookies
                        }, '*');
                    } catch (e) {
                        window.parent.postMessage({
                            type: 'COOKIES_RESULT',
                            success: false,
                            error: e.message
                        }, '*');
                    }
                `;
                
                try {
                    iframe.contentWindow.eval(script);
                } catch (e) {
                    window.removeEventListener('message', messageHandler);
                    reject(new Error('No se puede acceder a las cookies del iframe. Verifica que hayas hecho login.'));
                }
                
                // Timeout de 15 segundos
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    reject(new Error('Timeout: No se pudieron obtener las cookies a tiempo.'));
                }, 15000);
            });
        }
        
        function mostrarEstado(tipo, mensaje) {
            const status = document.getElementById('status');
            status.className = 'status ' + tipo;
            status.innerHTML = mensaje.replace(/\\n/g, '<br>');
            status.style.display = 'block';
        }
        
        function ocultarEstado() {
            document.getElementById('status').style.display = 'none';
        }
        
        // Log de inicio
        console.log('üîê Sistema de renovaci√≥n iniciado');
        console.log('üåê N8N URL configurada:', n8nUrl);
        
        // Detectar si viene de Telegram
        if (document.referrer.includes('telegram') || window.opener) {
            console.log('üì± Acceso detectado desde Telegram');
        }
    </script>
</body>
</html>
